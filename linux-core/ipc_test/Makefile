# Linux IPC å­¦ä¹ é¡¹ç›® Makefile

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -O2 -D_GNU_SOURCE
LDFLAGS = -lpthread

# ç¨‹åºåˆ—è¡¨
PROGRAMS = pipe_demo msgqueue_demo sharedmem_demo semaphore_demo socket_demo

# æºæ–‡ä»¶
SOURCES = 1_pipe_demo.c 2_msgqueue_demo.c 3_sharedmem_demo.c 4_semaphore_demo.c 5_socket_demo.c

# é»˜è®¤ç›®æ ‡
all: $(PROGRAMS)

# ç¼–è¯‘è§„åˆ™
pipe_demo: 1_pipe_demo.c
	$(CC) $(CFLAGS) -o $@ $<
	@echo "âœ… $@ ç¼–è¯‘å®Œæˆ"

msgqueue_demo: 2_msgqueue_demo.c
	$(CC) $(CFLAGS) -o $@ $<
	@echo "âœ… $@ ç¼–è¯‘å®Œæˆ"

sharedmem_demo: 3_sharedmem_demo.c
	$(CC) $(CFLAGS) -o $@ $<
	@echo "âœ… $@ ç¼–è¯‘å®Œæˆ"

semaphore_demo: 4_semaphore_demo.c
	$(CC) $(CFLAGS) -o $@ $<
	@echo "âœ… $@ ç¼–è¯‘å®Œæˆ"

socket_demo: 5_socket_demo.c
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $<
	@echo "âœ… $@ ç¼–è¯‘å®Œæˆ"

# æ¸…ç†ç›®æ ‡
clean:
	rm -f $(PROGRAMS)
	@echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

# é‡æ–°ç¼–è¯‘
rebuild: clean all

# å®‰è£…
install: all
	sudo cp $(PROGRAMS) /usr/local/bin/
	@echo "ğŸ“¦ å®‰è£…å®Œæˆ"

# å¸è½½
uninstall:
	sudo rm -f $(addprefix /usr/local/bin/, $(PROGRAMS))
	@echo "ğŸ—‘ï¸  å¸è½½å®Œæˆ"

# è¿è¡Œæµ‹è¯•
test: all
	@echo "ğŸ§ª è¿è¡ŒåŸºæœ¬æµ‹è¯•..."
	@for prog in $(PROGRAMS); do \
		echo "æµ‹è¯• $$prog..."; \
		timeout 5 ./$$prog < /dev/null > /dev/null 2>&1 || true; \
		echo "$$prog æµ‹è¯•å®Œæˆ"; \
	done
	@echo "âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ"

# ä»£ç é£æ ¼æ£€æŸ¥
check:
	@echo "ğŸ” æ£€æŸ¥ä»£ç é£æ ¼..."
	@if command -v cppcheck >/dev/null 2>&1; then \
		cppcheck --enable=all --std=c99 --suppress=missingIncludeSystem $(SOURCES); \
	else \
		echo "âš ï¸  cppcheck æœªå®‰è£…ï¼Œè·³è¿‡æ£€æŸ¥"; \
	fi

# å†…å­˜æ£€æŸ¥
valgrind: all
	@echo "ğŸ” å†…å­˜æ£€æŸ¥..."
	@if command -v valgrind >/dev/null 2>&1; then \
		for prog in $(PROGRAMS); do \
			echo "æ£€æŸ¥ $$prog..."; \
			timeout 10 valgrind --leak-check=full --error-exitcode=1 ./$$prog < /dev/null > /dev/null 2>&1 || true; \
		done; \
	else \
		echo "âš ï¸  valgrind æœªå®‰è£…ï¼Œè·³è¿‡å†…å­˜æ£€æŸ¥"; \
	fi

# è°ƒè¯•ç‰ˆæœ¬
debug: CFLAGS += -g -DDEBUG
debug: clean all
	@echo "ğŸ› è°ƒè¯•ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"

# å‘å¸ƒç‰ˆæœ¬
release: CFLAGS += -O3 -DNDEBUG
release: clean all
	@echo "ğŸš€ å‘å¸ƒç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"

# æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "å¯ç”¨çš„ make ç›®æ ‡:"
	@echo "  all      - ç¼–è¯‘æ‰€æœ‰ç¨‹åº (é»˜è®¤)"
	@echo "  clean    - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  rebuild  - é‡æ–°ç¼–è¯‘"
	@echo "  install  - å®‰è£…åˆ°ç³»ç»Ÿ"
	@echo "  test     - è¿è¡ŒåŸºæœ¬æµ‹è¯•"
	@echo "  check    - ä»£ç é£æ ¼æ£€æŸ¥"
	@echo "  valgrind - å†…å­˜æ£€æŸ¥"
	@echo "  debug    - ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬"
	@echo "  release  - ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬"
	@echo "  help     - æ˜¾ç¤ºæ­¤å¸®åŠ©"

# ä¼ªç›®æ ‡
.PHONY: all clean rebuild install uninstall test check valgrind debug release help
