# TUN è®¾å¤‡ç½‘ç»œå·¥å…·å¥—ä»¶

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ Linux TUN è®¾å¤‡ç½‘ç»œå·¥å…·å¥—ä»¶ï¼ŒåŒ…å« TUN è®¾å¤‡åˆ›å»ºã€è·¯ç”±é…ç½®ã€é˜²ç«å¢™ç®¡ç†å’Œ VPN æœåŠ¡å™¨åŠŸèƒ½ã€‚

## ğŸš€ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº†ä¸€å¥—å®Œæ•´çš„ TUN è®¾å¤‡ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

- **åŸºç¡€ TUN è®¾å¤‡æ“ä½œ** - åˆ›å»ºã€é…ç½®å’Œç›‘å¬ TUN è®¾å¤‡
- **é«˜çº§è·¯ç”±åŠŸèƒ½** - è‡ªåŠ¨è·¯ç”±é…ç½®å’Œç®¡ç†
- **é˜²ç«å¢™é›†æˆ** - iptables è§„åˆ™è‡ªåŠ¨é…ç½®
- **VPN æœåŠ¡å™¨** - å®Œæ•´çš„ VPN æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆ
- **ç½‘ç»œè¯Šæ–­** - å…¨é¢çš„ç½‘ç»œåŠŸèƒ½æµ‹è¯•å·¥å…·

## ğŸ“ é¡¹ç›®ç»“æ„

```
tun_test/
â”œâ”€â”€ æ ¸å¿ƒç¨‹åº
â”‚   â”œâ”€â”€ tun_test.c          # åŸºç¡€ TUN è®¾å¤‡æµ‹è¯•ç¨‹åº
â”‚   â”œâ”€â”€ tun_router.c        # é«˜çº§ TUN è·¯ç”±å™¨ç¨‹åº
â”‚   â”œâ”€â”€ network_utils.c     # ç½‘ç»œå·¥å…·å‡½æ•°åº“
â”‚   â””â”€â”€ network_utils.h     # ç½‘ç»œå·¥å…·å¤´æ–‡ä»¶
â”œâ”€â”€ å¯æ‰§è¡Œæ–‡ä»¶
â”‚   â”œâ”€â”€ tun_test           # ç¼–è¯‘åçš„åŸºç¡€æµ‹è¯•ç¨‹åº
â”‚   â””â”€â”€ tun_router         # ç¼–è¯‘åçš„è·¯ç”±å™¨ç¨‹åº
â”œâ”€â”€ è‡ªåŠ¨åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ setup_vpn_server.sh    # VPN æœåŠ¡å™¨è‡ªåŠ¨è®¾ç½®è„šæœ¬
â”‚   â”œâ”€â”€ network_test.sh        # ç½‘ç»œåŠŸèƒ½å…¨é¢æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_demo.sh           # åŸºç¡€åŠŸèƒ½æ¼”ç¤ºè„šæœ¬
â”‚   â””â”€â”€ cleanup_network.sh     # ç½‘ç»œé…ç½®å®‰å…¨æ¸…ç†è„šæœ¬
â”œâ”€â”€ æ„å»ºå·¥å…·
â”‚   â””â”€â”€ Makefile              # æ„å»ºå’Œç®¡ç†å·¥å…·
â””â”€â”€ æ–‡æ¡£
    â””â”€â”€ README.md             # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### åŸºç¡€åŠŸèƒ½ (tun_test)
- âœ… TUN è®¾å¤‡åˆ›å»ºå’Œç®¡ç†
- âœ… ç½‘ç»œæ•°æ®åŒ…ç›‘å¬å’Œåˆ†æ
- âœ… IPv4 æ•°æ®åŒ…åè®®è§£æ
- âœ… å®æ—¶æ•°æ®åŒ…ä¿¡æ¯æ˜¾ç¤º
- âœ… è‡ªå®šä¹‰è®¾å¤‡åç§°æ”¯æŒ
- âœ… éé˜»å¡æ¨¡å¼æ•°æ®å¤„ç†

### é«˜çº§åŠŸèƒ½ (tun_router)
- ğŸŒ **è·¯ç”±ç®¡ç†**
  - è‡ªåŠ¨è·¯ç”±è¡¨é…ç½®
  - é™æ€è·¯ç”±æ·»åŠ /åˆ é™¤
  - é»˜è®¤ç½‘å…³é…ç½®
  - å¤šæ¥å£è·¯ç”±æ”¯æŒ

- ğŸ”¥ **é˜²ç«å¢™é›†æˆ**
  - iptables è§„åˆ™è‡ªåŠ¨é…ç½®
  - NAT å’Œç«¯å£è½¬å‘
  - æµé‡è¿‡æ»¤å’Œè½¬å‘
  - å®‰å…¨ç­–ç•¥ç®¡ç†

- ğŸ›¡ï¸ **VPN åŠŸèƒ½**
  - å®Œæ•´çš„ VPN æœåŠ¡å™¨
  - å®¢æˆ·ç«¯è¿æ¥ç®¡ç†
  - åŠ å¯†éš§é“æ”¯æŒ
  - å¤šç”¨æˆ·æ¥å…¥

- ğŸ“Š **ç½‘ç»œè¯Šæ–­**
  - è¿é€šæ€§æµ‹è¯•
  - æ€§èƒ½ç›‘æ§
  - æµé‡ç»Ÿè®¡
  - é”™è¯¯è¯Šæ–­

## ğŸ”§ å®‰è£…å’Œç¼–è¯‘

### ç³»ç»Ÿè¦æ±‚
- Linux æ“ä½œç³»ç»Ÿ (å†…æ ¸ 2.6+)
- GCC ç¼–è¯‘å™¨
- root æƒé™ (ç”¨äºç½‘ç»œé…ç½®)
- ä»¥ä¸‹å·¥å…·åŒ…ï¼š
  ```bash
  # Ubuntu/Debian
  sudo apt-get install build-essential iproute2 iptables
  
  # CentOS/RHEL
  sudo yum install gcc iproute2 iptables
  ```

### ç¼–è¯‘æ–¹æ³•

```bash
# ç¼–è¯‘æ‰€æœ‰ç¨‹åº
make all

# æˆ–è€…åˆ†åˆ«ç¼–è¯‘
make tun_test      # ç¼–è¯‘åŸºç¡€æµ‹è¯•ç¨‹åº
make tun_router    # ç¼–è¯‘è·¯ç”±å™¨ç¨‹åº

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
make clean

# å®‰è£…åˆ°ç³»ç»Ÿ
sudo make install

# å¸è½½
sudo make uninstall
```

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### 1. åŸºç¡€ TUN è®¾å¤‡æµ‹è¯•

```bash
# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
./tun_test -h

# åŸºæœ¬è®¾å¤‡åˆ›å»ºæµ‹è¯•
sudo ./tun_test -t

# åˆ›å»ºè‡ªå®šä¹‰åç§°è®¾å¤‡
sudo ./tun_test -d mytun -t

# å¯åŠ¨æ•°æ®åŒ…ç›‘å¬
sudo ./tun_test
```

#### å®Œæ•´æµ‹è¯•æµç¨‹
```bash
# ç»ˆç«¯ 1: å¯åŠ¨ç›‘å¬ç¨‹åº
sudo ./tun_test

# ç»ˆç«¯ 2: é…ç½®ç½‘ç»œæ¥å£
sudo ip addr add 10.0.0.1/24 dev tun0
sudo ip link set tun0 up

# ç»ˆç«¯ 3: å‘é€æµ‹è¯•æ•°æ®
ping 10.0.0.2
```

### 2. é«˜çº§è·¯ç”±å™¨åŠŸèƒ½

```bash
# æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
./tun_router -h

# åŸºæœ¬è·¯ç”±å™¨é…ç½®
sudo ./tun_router -r -f -e eth0 -n 10.0.0.0/24

# å¸¦ NAT çš„è·¯ç”±å™¨
sudo ./tun_router -r -N -f -e eth0 -n 10.0.0.0/24

# å¸¦ç«¯å£è½¬å‘çš„è·¯ç”±å™¨
sudo ./tun_router -r -N -f -e eth0 -p 8080 -t 10.0.0.100 -P 80 -T tcp

# ä»…é…ç½®æ¨¡å¼ï¼ˆä¸è¿è¡Œè½¬å‘æœåŠ¡ï¼‰
sudo ./tun_router -r -N -f -e eth0 -c

# æ˜¾ç¤ºå½“å‰ç½‘ç»œçŠ¶æ€
./tun_router -s
```

#### è·¯ç”±å™¨é€‰é¡¹è¯´æ˜
- `-d <è®¾å¤‡å>` - TUN è®¾å¤‡åç§°
- `-i <IPåœ°å€>` - TUN æ¥å£ IP åœ°å€
- `-m <å­ç½‘æ©ç >` - å­ç½‘æ©ç 
- `-e <å¤–éƒ¨æ¥å£>` - å¤–éƒ¨ç½‘ç»œæ¥å£
- `-n <å†…éƒ¨ç½‘ç»œ>` - å†…éƒ¨ç½‘ç»œæ®µ
- `-r` - å¯ç”¨è·¯ç”±åŠŸèƒ½
- `-N` - å¯ç”¨ NAT åŠŸèƒ½
- `-f` - å¯ç”¨ IP è½¬å‘
- `-p <ç«¯å£>` - ç«¯å£è½¬å‘å¤–éƒ¨ç«¯å£
- `-t <IP>` - ç«¯å£è½¬å‘ç›®æ ‡ IP
- `-P <ç«¯å£>` - ç«¯å£è½¬å‘ç›®æ ‡ç«¯å£
- `-T <åè®®>` - è½¬å‘åè®® (tcp/udp)

### 3. è‡ªåŠ¨åŒ–è„šæœ¬

#### VPN æœåŠ¡å™¨è®¾ç½®
```bash
# è‡ªåŠ¨è®¾ç½® VPN æœåŠ¡å™¨
sudo ./setup_vpn_server.sh

# å¯åŠ¨ VPN æœåŠ¡å™¨
sudo ./start_vpn_server.sh

# åœæ­¢ VPN æœåŠ¡å™¨
sudo ./stop_vpn_server.sh

# æ£€æŸ¥ VPN çŠ¶æ€
./vpn_status.sh
```

#### ç½‘ç»œåŠŸèƒ½æµ‹è¯•
```bash
# è¿è¡Œå…¨é¢çš„ç½‘ç»œåŠŸèƒ½æµ‹è¯•
sudo ./network_test.sh

# è¿è¡ŒåŸºç¡€æ¼”ç¤º
sudo ./test_demo.sh
```

#### ç½‘ç»œé…ç½®æ¸…ç†
```bash
# å®‰å…¨æ¸…ç†æ‰€æœ‰æµ‹è¯•é…ç½®
sudo ./cleanup_network.sh
```

## ğŸ› ï¸ Makefile ç›®æ ‡

| ç›®æ ‡ | åŠŸèƒ½ | ç”¨æ³• |
|------|------|------|
| `all` | ç¼–è¯‘æ‰€æœ‰ç¨‹åº | `make` |
| `clean` | æ¸…ç†ç¼–è¯‘æ–‡ä»¶ | `make clean` |
| `test` | è¿è¡ŒåŸºæœ¬æµ‹è¯• | `make test` |
| `test-network` | è¿è¡Œç½‘ç»œæµ‹è¯• | `make test-network` |
| `setup-vpn` | è®¾ç½® VPN æœåŠ¡å™¨ | `make setup-vpn` |
| `install` | å®‰è£…åˆ°ç³»ç»Ÿ | `make install` |
| `uninstall` | ä»ç³»ç»Ÿå¸è½½ | `make uninstall` |
| `help` | æ˜¾ç¤ºç¨‹åºå¸®åŠ© | `make help` |
| `check` | ä»£ç é£æ ¼æ£€æŸ¥ | `make check` |

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### æƒé™è¦æ±‚
- **å¿…é¡»ä½¿ç”¨ root æƒé™** è¿è¡Œæ‰€æœ‰ç½‘ç»œé…ç½®ç›¸å…³çš„ç¨‹åº
- TUN è®¾å¤‡åˆ›å»ºéœ€è¦ `CAP_NET_ADMIN` æƒé™
- iptables é…ç½®éœ€è¦ç®¡ç†å‘˜æƒé™

### ç³»ç»Ÿè¦æ±‚
1. **å†…æ ¸æ¨¡å—**: ç¡®ä¿åŠ è½½äº† `tun` æ¨¡å—
   ```bash
   sudo modprobe tun
   lsmod | grep tun
   ```

2. **è®¾å¤‡æ–‡ä»¶**: ç¡®ä¿å­˜åœ¨ `/dev/net/tun`
   ```bash
   ls -l /dev/net/tun
   ```

3. **ç½‘ç»œå·¥å…·**: ç¡®ä¿å®‰è£…äº† `iproute2` å’Œ `iptables`

### å®‰å…¨è€ƒè™‘
- æµ‹è¯•å®Œæˆåè¯·ä½¿ç”¨ `cleanup_network.sh` æ¸…ç†é…ç½®
- ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨æµ‹è¯•é…ç½®
- å»ºè®®åœ¨è™šæ‹Ÿæœºæˆ–éš”ç¦»ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

#### 1. æƒé™é”™è¯¯
```
é”™è¯¯: Permission denied
è§£å†³: sudo ./ç¨‹åºå
```

#### 2. TUN è®¾å¤‡ä¸å­˜åœ¨
```
é”™è¯¯: No such file or directory (/dev/net/tun)
è§£å†³: sudo modprobe tun
```

#### 3. ç¼–è¯‘é”™è¯¯
```
é”™è¯¯: æ‰¾ä¸åˆ°å¤´æ–‡ä»¶
è§£å†³: sudo apt-get install linux-headers-$(uname -r)
```

#### 4. ç½‘ç»œé…ç½®å†²çª
```
é”™è¯¯: è·¯ç”±å·²å­˜åœ¨
è§£å†³: sudo ./cleanup_network.sh
```

### ç³»ç»Ÿæ£€æŸ¥å‘½ä»¤
```bash
# æ£€æŸ¥ TUN æ”¯æŒ
cat /proc/modules | grep tun

# æ£€æŸ¥ç½‘ç»œæ¥å£
ip addr show

# æ£€æŸ¥è·¯ç”±è¡¨
ip route show

# æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
sudo iptables -L -n

# æ£€æŸ¥ IP è½¬å‘
cat /proc/sys/net/ipv4/ip_forward
```

## ğŸ“ˆ æ€§èƒ½ç‰¹æ€§

- **ä½å»¶è¿Ÿ**: ä¼˜åŒ–çš„æ•°æ®åŒ…å¤„ç†è·¯å¾„
- **é«˜åå**: æ”¯æŒé«˜é€Ÿç½‘ç»œæ•°æ®è½¬å‘
- **å†…å­˜æ•ˆç‡**: æœ€å°åŒ–å†…å­˜ä½¿ç”¨å’Œæ‹·è´
- **CPU å‹å¥½**: éé˜»å¡ I/O å’Œäº‹ä»¶é©±åŠ¨æ¶æ„

## ğŸ”® æ‰©å±•åŠŸèƒ½

é¡¹ç›®æ”¯æŒä»¥ä¸‹æ‰©å±•ï¼š

### å·²å®ç°åŠŸèƒ½
- âœ… åŸºç¡€ TUN è®¾å¤‡æ“ä½œ
- âœ… è·¯ç”±è¡¨ç®¡ç†
- âœ… iptables é›†æˆ
- âœ… NAT å’Œç«¯å£è½¬å‘
- âœ… ç½‘ç»œçŠ¶æ€ç›‘æ§
- âœ… è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬

### å¯æ‰©å±•åŠŸèƒ½
- ğŸ”„ IPv6 æ”¯æŒ
- ğŸ”„ åŠ å¯†éš§é“ (IPSec/OpenVPN é›†æˆ)
- ğŸ”„ è´Ÿè½½å‡è¡¡
- ğŸ”„ QoS æµé‡æ§åˆ¶
- ğŸ”„ Web ç®¡ç†ç•Œé¢
- ğŸ”„ æ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿ
- ğŸ”„ å¤šç§Ÿæˆ·æ”¯æŒ

## ğŸ“š ä»£ç ç»“æ„è¯´æ˜

### æ ¸å¿ƒæ¨¡å—

#### tun_test.c - åŸºç¡€åŠŸèƒ½
- `tun_alloc()` - TUN è®¾å¤‡åˆ›å»º
- `print_packet()` - æ•°æ®åŒ…åå…­è¿›åˆ¶æ˜¾ç¤º
- `analyze_packet()` - åè®®åˆ†æ
- `test_tun_read()` - æ•°æ®ç›‘å¬å¾ªç¯

#### tun_router.c - è·¯ç”±å™¨åŠŸèƒ½
- `configure_tun_router()` - è·¯ç”±å™¨é…ç½®
- `handle_packet_forwarding()` - æ•°æ®åŒ…è½¬å‘
- `cleanup_network_config()` - é…ç½®æ¸…ç†
- `signal_handler()` - ä¿¡å·å¤„ç†

#### network_utils.c - ç½‘ç»œå·¥å…·åº“
- **æ¥å£é…ç½®**: `configure_interface()`, `set_interface_ip()`
- **è·¯ç”±ç®¡ç†**: `add_route()`, `delete_route()`
- **é˜²ç«å¢™**: `add_iptables_rule()`, `setup_nat_masquerade()`
- **è¯Šæ–­å·¥å…·**: `ping_host()`, `check_connectivity()`

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œæ”¹è¿›å»ºè®®ï¼

### å¼€å‘ç¯å¢ƒè®¾ç½®
```bash
git clone <repository>
cd tun_test
make all
sudo make test-network
```

### ä»£ç é£æ ¼
- ä½¿ç”¨ C99 æ ‡å‡†
- éµå¾ª Linux å†…æ ¸ä»£ç é£æ ¼
- æ·»åŠ é€‚å½“çš„æ³¨é‡Šå’Œæ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨å¼€æºè®¸å¯è¯ï¼Œè¯¦è§ LICENSE æ–‡ä»¶ã€‚

## ğŸ†˜ æ”¯æŒå’Œå¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼š

1. æŸ¥çœ‹æœ¬ README çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. è¿è¡Œ `sudo ./network_test.sh` è¿›è¡Œç³»ç»Ÿæ£€æŸ¥
3. ä½¿ç”¨ `sudo ./cleanup_network.sh` æ¸…ç†é…ç½®
4. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

---

**âš¡ å¿«é€Ÿå¼€å§‹**: `make all && sudo make test`

**ğŸ”§ å®Œæ•´æµ‹è¯•**: `sudo make test-network`

**ğŸŒ VPN æœåŠ¡å™¨**: `sudo make setup-vpn`

**ğŸ§¹ æ¸…ç†é…ç½®**: `sudo ./cleanup_network.sh`